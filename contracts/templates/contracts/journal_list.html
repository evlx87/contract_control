{% extends 'contracts/base.html' %}
{% block title %}
<title>
    {{ page_title|title }}
</title>
{% endblock %}
{% block page_header %}
    <h1>Журнал регистрации контрактов</h1>
{% endblock %}
{% block page_content %}
{% if user.is_authenticated %}
<div class="button_container">
    <a class="pp_button" href="{% url 'contracts:add_contract' %}">Добавить</a>
    <a class="pp_button" href="{% url 'contracts:export_excel' %}">Экспорт в Excel</a>
</div>
{% endif %}

<div class="button_container">
    <form method="get" class="filter-form">
        <label for="year">Выберите год:</label>
        <select name="year" id="year">
            <option value="">Все</option>
            {% for year in years %}
                <option value="{{ year.year }}"
                    {% if selected_year == year.year %}selected{% endif %}>
                    {{ year.year }}
                </option>
            {% endfor %}
        </select>
        <label for="purchase_type">Выберите тип закупки:</label>
        <select name="purchase_type" id="purchase_type">
            <option value="">Все</option>
            {% for purchase_type in purchase_types %}
                <option value="{{ purchase_type }}"
                    {% if selected_purchase_type == purchase_type %}selected{% endif %}>
                    {{ purchase_type }}
                </option>
            {% endfor %}
        </select>
        <button type="submit" class="pp_button">Применить</button>
    </form>
</div>

<div class="table-container">
    <table border="1" cellpadding="2" cellspacing="0" class="display compact purchase-table" id="journalTable">
        <thead>
            <tr>
                <th>Дата контракта</th>
                <th>Номер контракта</th>
                <th>Контрагент</th>
                <th>Предмет контракта</th>
                <th>Срок действия контракта</th>
                <th>Дата начала услуг/поставки</th>
                <th>Дата окончания услуг/поставки</th>
                <th>Сумма контракта</th>
                <th>Тип закупки</th>
            </tr>
        </thead>
        <tbody>
            {% for purchase in purchases %}
            <tr {% if purchase.contract_duration|date:"U"|floatformat:0|add:0 < now|date:"U"|floatformat:0|add:2592000 %}class="highlight-danger"{% endif %}>
                <td>{{ purchase.contract_date|date:"d.m.Y" }}</td>
                <td><a href="{% url 'contracts:contract-detail' purchase.id %}">{{ purchase.contract_number }}</a></td>
                <td>{{ purchase.supplier }}</td>
                <td>{{ purchase.contract_subject }}</td>
                <td>{{ purchase.contract_duration|date:"d.m.Y" }}</td>
                <td>{{ purchase.service_start_date|date:"d.m.Y" }}</td>
                <td>{{ purchase.service_end_date|date:"d.m.Y" }}</td>
                <td>{{ purchase.contract_amount }}</td>
                <td>{{ purchase.purchase_type}}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="no-data">Нет данных о контрактах.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function() {
        $('#journalTable').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/ru.json"
            },
            "paging": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true
        });
    });
</script>
{% endblock %}